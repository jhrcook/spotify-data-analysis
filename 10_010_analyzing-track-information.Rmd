---
title: "Analyzing my track details"
description: |
  A deep analysis of some of my favorite songs.
author:
  - first_name: "Joshua"
    last_name: "Cook"
    url: https://joshuacook.netlify.app
    orcid_id: 0000-0001-9815-6879
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = "#>")

library(nakedpipe)
library(magrittr)
library(ggthemes)
library(ggrepel)
library(ggtext)
library(tidyverse)

# To shut-up `summarise()`.
options(dplyr.summarise.inform = FALSE)

theme_set(ggthemes::theme_fivethirtyeight())
pal_538 <- deframe(ggthemes_data[["fivethirtyeight"]])

walk(list.files("lib", pattern = "R$", full.names = TRUE), source)

track_info_df <- readRDS(here::here("data", "track_detailed_info.rds"))
playlist_df <- readRDS(here::here("data", "playlist_detailed_info.rds"))

set.seed(0)
```

Mark songs that are just background noise.

```{r}
track_to_playlist_map <- playlist_df %.% {
  select(playlist_name = name, playlist_id = id, data)
  unnest(data)
  select(playlist_name:track_id)
  distinct()
  group_by(track_name, track_id)
  nest()
  rename(playlist_data = data)
}

background_playlists <- c(
  "Coffee Shop Sounds", "Deep Focus", "Good Bakcground",
  "Your Favorite Coffeehouse", "Emotional Sounds", "Peaceful Nature"
)

instrumental_playlists <- c("Instrumental", "Classical Playlist")

ignore_playlists <- c("Discover Weekly")

regular_playlists <- unique(playlist_df$name)
idx <- regular_playlists %in% c(
  background_playlists,
  instrumental_playlists,
  ignore_playlists
)
regular_playlists <- regular_playlists[!idx]
```

```{r}
track_features <- track_info_df %.% {
  select(track_name:album_name, danceability:tempo)
}

track_features_mat <- track_features %.% {
  select(track_id, danceability:tempo)
  as.data.frame()
  column_to_rownames("track_id")
}

track_pca <- prcomp(track_features_mat, scale. = TRUE, center = TRUE)

add_playlist_names <- function(df,
                               playlist_df,
                               by = c("track_name", "track_id")) {
  left_join(df, playlist_df, by = by) %>%
    mutate(playlist = map_chr(playlist_data, function(df) {
      if (nrow(df) > 1) {
        return("multiple")
      }
      return(df$playlist_name[[1]])
    }))
}

track_pcs_df <- track_features %.% {
  select(track_name:album_name)
  bind_cols(track_pca$x[, 1:2] %>% as_tibble())
  add_playlist_names(track_to_playlist_map)
}
```

```{r}
as.data.frame(t(summary(track_pca)$importance)) %.%
  {
    janitor::clean_names()
    rownames_to_column("PC")
    mutate(PC = as.numeric(str_remove(PC, "^PC")))
  } %>%
  ggplot(aes(PC, proportion_of_variance)) +
  geom_col(fill = "grey50", width = 0.7) +
  geom_line(color = colorspace::darken(spotify_green), size = 1, lty = 2) +
  geom_point(color = colorspace::darken(spotify_green), size = 3) +
  scale_x_continuous(
    breaks = 1:20
  ) +
  scale_y_continuous(
    expand = expansion(mult = c(0, 0.02)),
    breaks = seq(0, 0.4, 0.05),
  ) +
  theme(
    axis.title.x = element_text(),
    axis.title.y = element_text(),
    panel.grid.major.x = element_blank()
  ) +
  labs(x = "principal components", y = "porportion of variance")
```

```{r}
track_pca$rotation %.%
  {
    as.data.frame()
    rownames_to_column(var = "feature")
    as_tibble()
  } %>%
  ggplot(aes(PC1, PC2)) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  ggrepel::geom_label_repel(
    aes(label = feature),
    fill = spotify_dark,
    color = "white",
    label.size = 0,
    fontface = "bold",
    label.padding = unit(1.3, "mm"),
    label.r = unit(1, "mm")
  ) +
  theme(
    axis.title.x = element_text(),
    axis.title.y = element_text()
  ) +
  labs(x = "PC1", y = "PC2", title = "Contribution of song features to decomposition")
```

```{r, fig.height=8}
plot_track_pca <- function(df, x, y, color = NULL, size = NULL, alpha = 0.6) {
  df %>%
    ggplot(aes(x = {{ x }}, y = {{ y }})) +
    geom_point(aes(color = {{ color }}, size = {{ size }}), alpha = alpha) +
    theme(
      axis.title.x = element_text(),
      axis.title.y = element_text(),
      legend.title = element_blank()
    )
}

plot_track_pca(track_pcs_df, PC1, PC2, color = playlist) +
  scale_color_discrete(
    guide = guide_legend(nrow = 6)
  )
```

```{r, fig.height=7}
add_playlist_groups <- function(df) {
  df %>%
    mutate(playlist_grp = case_when(
      playlist_name %in% background_playlists ~ "Background",
      playlist_name %in% instrumental_playlists ~ "Instrumental",
      playlist_name %in% regular_playlists ~ "Rock & Hip Hop",
      playlist_name %in% ignore_playlists ~ "Discover Weekly"
    ))
}

group_playlist_groups <- function(df, ...) {
  df %>%
    select(...) %>%
    group_by(...) %>%
    distinct() %>%
    summarise(playlist_grp = ifelse(n() > 1, "multiple", playlist_grp)) %>%
    ungroup()
}


track_pcs_df %.%
  {
    unnest(playlist_data)
    add_playlist_groups()
    group_playlist_groups(track_name, track_id, PC1, PC2, playlist_grp)
  } %>%
  plot_track_pca(PC1, PC2, color = playlist_grp) +
  scale_color_brewer(
    type = "qual", palette = "Set1",
    guide = guide_legend(nrow = 1)
  ) +
  labs(
    x = "PC1",
    y = "PC2",
    title = "PCA: Playlist Category"
  )
```

```{r, fig.height=7}
scale_numeric <- function(x, na.rm = TRUE) {
  (x - mean(x, na.rm = na.rm)) / sd(x, na.rm = na.rm)
}

track_pcs_df %.%
  {
    left_join(
      track_features %>% select(-c(album_name, album_id)),
      by = c("track_name", "track_id")
    )
    mutate(
      acousticness = scale_numeric(acousticness),
      loudness = scale_numeric(loudness),
      color = loudness - acousticness,
    )
  } %>%
  plot_track_pca(
    PC1,
    PC2,
    color = color,
    alpha = 1
  ) +
  annotate(
    "text",
    x = c(-1.2, 1.2), y = -3,
    label = c("Acousticness", "Loudness"),
    color = c("#3775B9", "#FE5B31"),
    size = 5,
    fontface = "bold",
    hjust = c(1, 0)
  ) +
  annotate(
    "segment",
    x = 0, y = -3, xend = c(-0.7, 0.7), yend = -3,
    arrow = arrow(length = unit(2, "mm"), type = "closed")
  ) +
  scale_color_distiller(type = "div", palette = "RdYlBu") +
  scale_size_continuous(range = c(1, 3)) +
  labs(
    x = "PC1",
    y = "PC2",
    title = "Distribution of the features defining PC1"
  )
```

```{r, fig.height=7}
track_tsne_data <- as.data.frame(track_features_mat) %.% {
  rownames_to_column("track_id")
  mutate_if(is.numeric, scale_numeric)
  column_to_rownames("track_id")
  distinct()
}

track_tsne <- track_tsne_data %>%
  Rtsne::Rtsne()

track_tsne_df <- as_tibble(track_tsne$Y) %.% {
  mutate(track_id = rownames(track_tsne_data))
  add_playlist_names(track_to_playlist_map, by = "track_id")
}

track_tsne_df %>%
  plot_track_pca(V1, V2, color = playlist) +
  labs(x = "t-SNE 1", y = "t-SNE 2", title = "t-SNE: Separation by playlist")
```


```{r, fig.height=7}
track_tsne_df %.%
  {
    unnest(playlist_data)
    add_playlist_groups()
    group_playlist_groups(track_name, track_id, V1, V2, playlist_grp)
  } %>%
  plot_track_pca(V1, V2, color = playlist_grp) +
  scale_color_brewer(
    type = "qual", palette = "Set1",
    guide = guide_legend(nrow = 1)
  ) +
  labs(x = "t-SNE 1", y = "t-SNE 2", title = "t-SNE: Separation by playlist category")
```

analyses:

- PCA, t-SNE, hierarchical clustering of songs by track features
  - plot with various color aesthetics: playlist, popularity, whatever features are most aligned with PCs 1 and 2

(hierarchical clustering wasn't very insightful)

---

## Analysis of track segments of *Stacy* by Quinn XCII

```{r}
stacy_analysis <- track_info_df %>%
  filter(track_name == "Stacy")
```

```{r}
stacy_sections <- as_tibble(stacy_analysis$sections[[1]])
rmarkdown::paged_table(stacy_sections)
```

```{r}
bind_rows(
  stacy_analysis$bars[[1]] %>% add_column(type = "bars"),
  stacy_analysis$beats[[1]] %>% add_column(type = "beats"),
  stacy_analysis$tatums[[1]] %>% add_column(type = "tatums")
) %.%
  {
    as_tibble()
  } %>%
  ggplot(aes(x = start, y = duration, color = type)) +
  facet_wrap(~type, scales = "free_y", ncol = 1) +
  geom_point(alpha = 0.5) +
  scale_color_fivethirtyeight() +
  theme(
    plot.title = element_markdown(),
    legend.position = "none"
  ) +
  labs(
    x = "time (ms)",
    y = "confidence",
    title = "Duration of timing features throughout *Stacy*"
  )
```

```{r}
bind_rows(
  stacy_analysis$bars[[1]] %>% add_column(type = "bars"),
  stacy_analysis$beats[[1]] %>% add_column(type = "beats"),
  stacy_analysis$tatums[[1]] %>% add_column(type = "tatums")
) %.%
  {
    as_tibble()
  } %>%
  ggplot(aes(x = start, y = confidence, color = type)) +
  facet_wrap(~type, ncol = 1) +
  geom_hline(yintercept = 0.5, color = pal_538["Dark Gray"], size = 1, alpha = 0.7) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", formula = "y~x", span = 0.2, se = FALSE) +
  scale_color_fivethirtyeight() +
  theme(
    legend.position = "none"
  ) +
  labs(
    x = "time (ms)",
    y = "confidence",
    title = "Confidence in declaration of song timing features"
  )
```

```{r}
stacy_segment_tidy <- stacy_analysis$segments[[1]] %.% {
  as_tibble()
  mutate(
    idx = row_number(),
    loudness_max = map(loudness_max, ~ c(.))
  )
  select(idx, start, loudness_max, pitches, timbre)
  pivot_longer(-c(idx, start))
  unnest(value)
}

stacy_segment_tidy %>%
  ggplot(aes(x = start, y = value, color = name)) +
  facet_wrap(~name, scales = "free_y", ncol = 1) +
  geom_point(size = 0.5, alpha = 0.3) +
  scale_color_fivethirtyeight(guide = FALSE) +
  theme(
    plot.title = element_markdown(),
    axis.title.x = element_text()
  ) +
  labs(
    title = "Segment analysis of *Stacy*",
    x = "time point"
  )
```

```{r}
stacy_segment_tidy %.%
  {
    filter(name == "pitches")
    group_by(idx, start)
    summarise(avg_pitch = mean(value))
    ungroup()
  } %>%
  ggplot(aes(x = start, y = avg_pitch)) +
  geom_point(size = 1, alpha = 0.9, color = pal_538["Blue"]) +
  geom_smooth(method = "loess", formula = "y~x", span = 0.5, color = colorspace::darken(pal_538["Blue"], 0.3)) +
  theme(
    plot.title = element_markdown()
  ) +
  labs(
    title = "Average pitch of *Stacy*"
  )
```

```{r}
tibble(pitches = unlist(stacy_analysis$segments[[1]]$pitches)) %>%
  ggplot(aes(x = pitches)) +
  geom_histogram(binwidth = 0.05)
```
