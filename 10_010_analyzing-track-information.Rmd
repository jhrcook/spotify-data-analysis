---
title: "Analyzing my track details"
description: |
  A deep analysis of some of my favorite songs.
author:
  - first_name: "Joshua"
    last_name: "Cook"
    url: https://joshuacook.netlify.app
    orcid_id: 0000-0001-9815-6879
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = "#>")

library(nakedpipe)
library(magrittr)
library(ggthemes)
library(ggrepel)
library(ggtext)
library(tidyverse)

# To shut-up `summarise()`.
options(dplyr.summarise.inform = FALSE)

theme_set(ggthemes::theme_fivethirtyeight())
pal_538 <- deframe(ggthemes_data[["fivethirtyeight"]])

walk(list.files("lib", pattern = "R$", full.names = TRUE), source)

track_info_df <- readRDS(here::here("data", "track_detailed_info.rds"))
playlist_df <- readRDS(here::here("data", "playlist_detailed_info.rds"))
```

Mark songs that are just background noise.

```{r}
stop("Use `playlist_df` to mark various forms of songs (piano, background, normal)")
```


```{r}
track_features <- track_info_df %.% {
  select(track_name:album_name, danceability:tempo)
}

track_features_mat <- track_features %.% {
  select(track_id, danceability:tempo)
  as.data.frame()
  column_to_rownames("track_id")
}

track_pca <- prcomp(track_features_mat, scale. = TRUE, center = TRUE)

track_pcs_df <- track_features %.% {
  select(track_name:album_name)
  bind_cols(track_pca$x[, 1:2] %>% as_tibble())
}


p <- track_pcs_df %>%
  ggplot(aes(x = PC1, y = PC2)) +
  geom_point(aes(label = track_name)) +
  theme(
    axis.title.x = element_text(),
    axis.title.y = element_text()
  ) +
  labs(x = "PC1", y = "PC2")
plotly::ggplotly(p)
```


analyses:

- PCA, t-SNE, hierarchical clustering of songs by track features
  - plot with various color aesthetics: playlist, popularity, whathever features are most aligned with PCs 1 and 2

---

## Analysis of track segments of *Stacy* by Quinn XCII

```{r}
stacy_analysis <- track_info_df %>%
  filter(track_name == "Stacy")
```

```{r}
stacy_sections <- as_tibble(stacy_analysis$sections[[1]])
rmarkdown::paged_table(stacy_sections)
```

```{r}
bind_rows(
  stacy_analysis$bars[[1]] %>% add_column(type = "bars"),
  stacy_analysis$beats[[1]] %>% add_column(type = "beats"),
  stacy_analysis$tatums[[1]] %>% add_column(type = "tatums")
) %.%
  {
    as_tibble()
  } %>%
  ggplot(aes(x = start, y = duration, color = type)) +
  facet_wrap(~type, scales = "free_y", ncol = 1) +
  geom_point(alpha = 0.5) +
  scale_color_fivethirtyeight() +
  theme(
    plot.title = element_markdown(),
    legend.position = "none"
  ) +
  labs(
    x = "time (ms)",
    y = "confidence",
    title = "Duration of timing features throughout *Stacy*"
  )
```

```{r}
bind_rows(
  stacy_analysis$bars[[1]] %>% add_column(type = "bars"),
  stacy_analysis$beats[[1]] %>% add_column(type = "beats"),
  stacy_analysis$tatums[[1]] %>% add_column(type = "tatums")
) %.%
  {
    as_tibble()
  } %>%
  ggplot(aes(x = start, y = confidence, color = type)) +
  facet_wrap(~type, ncol = 1) +
  geom_hline(yintercept = 0.5, color = pal_538["Dark Gray"], size = 1, alpha = 0.7) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", formula = "y~x", span = 0.2, se = FALSE) +
  scale_color_fivethirtyeight() +
  theme(
    legend.position = "none"
  ) +
  labs(
    x = "time (ms)",
    y = "confidence",
    title = "Confidence in declaration of song timing features"
  )
```

```{r}
stacy_segment_tidy <- stacy_analysis$segments[[1]] %.% {
  as_tibble()
  mutate(
    idx = row_number(),
    loudness_max = map(loudness_max, ~ c(.))
  )
  select(idx, start, loudness_max, pitches, timbre)
  pivot_longer(-c(idx, start))
  unnest(value)
}

stacy_segment_tidy %>%
  ggplot(aes(x = start, y = value, color = name)) +
  facet_wrap(~name, scales = "free_y", ncol = 1) +
  geom_point(size = 0.5, alpha = 0.3) +
  scale_color_fivethirtyeight(guide = FALSE) +
  theme(
    plot.title = element_markdown(),
    axis.title.x = element_text()
  ) +
  labs(
    title = "Segment analysis of *Stacy*",
    x = "time point"
  )
```

```{r}
stacy_segment_tidy %.%
  {
    filter(name == "pitches")
    group_by(idx, start)
    summarise(avg_pitch = mean(value))
    ungroup()
  } %>%
  ggplot(aes(x = start, y = avg_pitch)) +
  geom_point(size = 1, alpha = 0.9, color = pal_538["Blue"]) +
  geom_smooth(method = "loess", formula = "y~x", span = 0.5, color = colorspace::darken(pal_538["Blue"], 0.3)) +
  theme(
    plot.title = element_markdown()
  ) +
  labs(
    title = "Average pitch of *Stacy*"
  )
```

```{r}
tibble(pitches = unlist(stacy_analysis$segments[[1]]$pitches)) %>%
  ggplot(aes(x = pitches)) +
  geom_histogram(binwidth = 0.05)
```
