---
title: "Data Preparation"
description: |
  Preparation of the raw data downloaded from Spotify.
author:
  - first_name: "Joshua"
    last_name: "Cook"
    url: https://joshuacook.netlify.app
    orcid_id: 0000-0001-9815-6879
date: "December 7, 2020"
output:
  distill::distill_article:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, dpi = 500, comment = "#>")

library(mustashe)
library(jhcutils)
library(nakedpipe)
library(kableExtra)
library(tidyverse)

theme_set(theme_minimal())

raw_data_dir <- here::here("_raw-data", "MyData")
data_dir <- here::here("data")
```

## Streaming History

Prepare the streaming data that is contained in two JSON files.

```{r, echo=TRUE}
parse_streaming_history <- function(f) {
  rjson::fromJSON(file = f) %.% {
    map(as_tibble)
    bind_rows()
    janitor::clean_names()
    mutate(
      end_time = lubridate::ymd_hm(end_time),
      sec_played = ms_played / 1e3
    )
    select(-ms_played)
  }
}

streaming_history <- map_chr(
  seq(0, 1),
  ~ glue::glue("StreamingHistory{.x}.json")
) %>%
  map(~ file.path(raw_data_dir, .x)) %>%
  map(parse_streaming_history) %>%
  bind_rows()

saveRDS(streaming_history, file.path(data_dir, "streaming_history.rds"))
```

There are four columns in this data frame:

- `end_time`: when the song finished playing
- `artist_name`: the artist
- `track_name`: name of the song
- `sec_played`: duration of the song (in seconds)

```{r}
display_head <- function(df) {
  df %>%
    head() %>%
    kbl() %>%
    kable_styling(bootstrap_options = c("striped", "hover"))
}

display_head(streaming_history)
```

## Inferences

I am most excited for the "Inferences" data set.
Preparing this is still a work in progress and will require looking at their online documentation.
From a skim, some interesting notes are:

- `3P_Politics - Any Republican_US`, `3P_Politics - Registered Republican_US`,`3P_Politics - Any Democrat_US`, `3P_Politics - Registered Democrat_US`
- `3P_Custom__CNN_US`, `3P_Custom__Conservative Affinity TV News_US`, `3P_Custom__DailyShow_16Oct2020_US`
- `3p_Anime_Manga_Enthusiast_Es`
- `3P_Women's Apparel_CA`
- `3P_Alcohol Consumers_UK` (and some others)
- `3P__Custom_Cigarette Buyers_12Dec2019_US [Do Not Use in 2021]`
- `3P_Custom_Netflix_US`
- `3P_Custom_Parents of Boys 6-11_US`, `3P_Custom_Parents of Kids 5-13_28Apr2020_US`, `3P_Custom_Parents of Toddlers_30Nov2020_US`, etc.

```{r, echo=TRUE}
inferences <- rjson::fromJSON(file = file.path(raw_data_dir, "Inferences.json"))
inferences <- tibble(inference = inferences$inference)
```

```{r}
saveRDS(inferences, file.path(data_dir, "inferences.rds"))
display_head(inferences)
```

## Search Queries

```{r, echo=TRUE}
search_queries <- rjson::fromJSON(file = file.path(raw_data_dir, "SearchQueries.json")) %>%
  head() %>%
  map(function(x) {
    df <- as_tibble(x)
    df$searchInteractionURIs <- list(df$searchInteractionURIs)
    return(df)
  }) %>%
  bind_rows() %>%
  janitor::clean_names() %>%
  rename(search_interaction_uris = search_interaction_ur_is) %>%
  mutate(search_time = lubridate::ymd_hms(search_time))
```

```{r}
saveRDS(search_queries, file.path(data_dir, "search_queries.rds"))
display_head(search_queries)
```
